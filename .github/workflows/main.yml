name: Test

on:
  push:
    branches:
      - 3.*
  pull_request:

jobs:
  test:
    name: Test
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v2
      - name: Register problem matchers
        run: echo "::add-matcher::.github/problem-matchers/pospell.json"
      - uses: lots0logs/gh-action-get-changed-files@2.1.4
        id: changed_files
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Preparar Python v3.11
        uses: actions/setup-python@v2
        with:
          python-version: "3.11"
      - name: Sincronizar con CPython
        run: |
          git submodule update --init --depth=1 cpython
      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y hunspell hunspell-es gettext language-pack-es
          python -m pip install -r requirements.txt
          pip list
          pospell --version
          powrap --version
      - name: TRANSLATORS
        run: |
          diff -Naur TRANSLATORS <(LANG=es python scripts/sort.py < TRANSLATORS)
      - name: Powrap
        run: powrap --check --quiet **/*.po
      - name: Pospell
        run: |
          python scripts/check_spell.py
      - name: Padpoes
        env:
          ADDED_FILES: ${{ join(fromJSON(steps.changed_files.outputs.added), ' ') }}
          MODIFIED_FILES: ${{ join(fromJSON(steps.changed_files.outputs.modified), ' ') }}
        run: |
          CHANGED_PO_FILES=$(printf "%s %s\n" "$ADDED_FILES" "$MODIFIED_FILES" | tr ' ' '\n' | grep '.po$'; true)
          if [ -n "$CHANGED_PO_FILES" ]
          then
            echo "Running on:" $CHANGED_PO_FILES
            padpoes -i $CHANGED_PO_FILES 2>&1 | grep -v -Ff padpoes.ignore
          else
            echo "No changed po files, nothing to check."
          fi
      - name: Construir documentaci√≥n
        run: |
          # FIXME: Relative paths for includes in 'cpython'
          sed -i -e 's|.. include:: ../includes/wasm-notavail.rst|.. include:: ../../../../includes/wasm-notavail.rst|g' cpython/Doc/**/*.rst
          sed -i -e 's|.. include:: ../distutils/_setuptools_disclaimer.rst|.. include:: ../../../../distutils/_setuptools_disclaimer.rst|g' cpython/Doc/**/*.rst
          sed -i -e 's|.. include:: ./_setuptools_disclaimer.rst|.. include:: ../../../_setuptools_disclaimer.rst|g' cpython/Doc/**/*.rst
          sed -i -e 's|.. include:: token-list.inc|.. include:: ../../../token-list.inc|g' cpython/Doc/**/*.rst
          sed -i -e 's|.. include:: ../../using/venv-create.inc|.. include:: ../using/venv-create.inc|g' cpython/Doc/**/*.rst
          sed -i -e 's|.. include:: ../../../using/venv-create.inc|.. include:: ../../using/venv-create.inc|g' cpython/Doc/**/*.rst
          sed -i -e 's|.. include:: /using/venv-create.inc|.. include:: ../../../../using/venv-create.inc|g' cpython/Doc/**/*.rst
          # Normal build
          PYTHONWARNINGS=ignore::FutureWarning,ignore::RuntimeWarning sphinx-build -j auto -W --keep-going -b html -d cpython/Doc/_build/doctree -D language=es . cpython/Doc/_build/html
